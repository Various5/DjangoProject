<!-- pcrmgmtAPP/templates/maintenance/config_form.html -->
{% extends 'base.html' %}
{% block title %}Create/Edit Maintenance Config{% endblock %}

{% block content %}
<h1>Maintenance Config</h1>
<div class="mb-4 position-relative" style="max-width: 400px;">
  <label for="combinedSearch" class="form-label">Search Customer (Autocomplete):</label>
  <input type="text" id="combinedSearch" class="form-control"
         placeholder="Enter name, company, or email" autocomplete="off">
  <ul id="searchSuggestions" class="list-group position-absolute w-100" style="z-index:1000; display:none;"></ul>
</div>

<form method="post">
  {% csrf_token %}
  {{ form.as_p }}

  <!-- The forms.py fields:
       customer_firma, customer_vorname, ...
       next_due_date => date input
  -->

  <button type="submit" class="btn btn-success">Save</button>
</form>

<script>
document.addEventListener("DOMContentLoaded", function(){
    const searchInput = document.getElementById("combinedSearch");
    const searchSuggestions = document.getElementById("searchSuggestions");

    // We'll fill e.g. 'id_customer_firma', 'id_customer_vorname', 'id_customer_nachname',
    // 'id_customer_strasse', 'id_customer_plz', 'id_customer_ort' from the server

    searchInput.addEventListener("input", function() {
        const query = this.value.trim();
        if (query.length > 2) {
            fetch(`/autocomplete/customer/?query=${encodeURIComponent(query)}`)
                .then(resp => resp.json())
                .then(data => {
                    searchSuggestions.innerHTML = "";
                    if (!data.length) {
                        searchSuggestions.style.display = "none";
                        return;
                    }
                    searchSuggestions.style.display = "block";

                    data.forEach(item => {
                        const li = document.createElement("li");
                        li.className = "list-group-item";
                        // e.g. show "Firma (Nachname Vorname)"
                        li.textContent = `${item.firma} (${item.nachname} ${item.vorname})`;
                        li.addEventListener("click", () => {
                            // Fill the form fields
                            document.getElementById("id_customer_firma").value = item.firma || "";
                            document.getElementById("id_customer_vorname").value = item.vorname || "";
                            document.getElementById("id_customer_nachname").value = item.nachname || "";
                            document.getElementById("id_customer_strasse").value = item.strasse || "";
                            document.getElementById("id_customer_plz").value = item.plz || "";
                            document.getElementById("id_customer_ort").value = item.ort || "";

                            // Hide suggestions
                            searchSuggestions.style.display = "none";
                            searchInput.value = "";
                        });
                        searchSuggestions.appendChild(li);
                    });
                })
                .catch(console.error);
        } else {
            searchSuggestions.style.display = "none";
        }
    });
});
</script>
{% endblock %}
