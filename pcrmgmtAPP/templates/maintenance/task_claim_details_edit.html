{% extends "base.html" %}
{% load static %}

{% block title %}Edit Task Claim Details – Task #{{ task.id }}{% endblock %}

{% block content %}
<div class="container my-4">
  <h1>Edit Task Claim Details – Task #{{ task.id }} – {{ task.config.customer_firma }}</h1>
  <p><strong>Due Date:</strong> {{ task.due_date|date:"d.m.Y H:i" }}</p>
  <p><strong>Status:</strong> {{ task.status }}</p>
  <p><strong>Claimed At:</strong> {{ task.claimed_at|date:"d.m.Y H:i" }}</p>

  <!-- Timer Display -->
  <div class="mt-4">
    <h3>Timer</h3>
    <p>Time Spent: <span id="timer">00:00:00</span></p>
  </div>

  <!-- Formular für Bearbeitung (inkl. Datei‑Upload) -->
  <form id="claim-details-form" method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    <!-- Zuweisung -->
    <div class="form-group mb-4">
      <label for="assigned_to" class="form-label">Reassign to User:</label>
      <select id="assigned_to" name="assigned_to" class="form-select">
        <option value="">(Keep current assignee)</option>
        {% for user in user_list %}
          <option value="{{ user.id }}" {% if task.assigned_to == user %}selected{% endif %}>{{ user.username }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Basisfelder -->
    <div class="mb-3">
      <label for="start_date" class="form-label">Start Date:</label>
      <input type="datetime-local" id="start_date" name="start_date" class="form-control" value="{{ start_date_formatted }}">
    </div>
    <div class="mb-3">
      <label for="due_date" class="form-label">Due Date:</label>
      <input type="datetime-local" id="due_date" name="due_date" class="form-control" value="{{ due_date_formatted }}">
    </div>
    <div class="mb-3">
      <label for="status" class="form-label">Status:</label>
      <select id="status" name="status" class="form-select">
        <option value="open" {% if task.status == "open" %}selected{% endif %}>Open</option>
        <option value="claimed" {% if task.status == "claimed" %}selected{% endif %}>Claimed</option>
        <option value="done" {% if task.status == "done" %}selected{% endif %}>Done</option>
      </select>
    </div>
    <div class="mb-3">
      <label for="duration_minutes" class="form-label">Duration (minutes):</label>
      <input type="number" id="duration_minutes" name="duration_minutes" class="form-control" value="{{ task.duration_minutes }}">
    </div>

    <hr>

    <h4>Maintenance Sub-checks</h4>
    {% for log_item in logs %}
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>{{ log_item.sub_check_name }}</strong>
        <div class="form-check mb-0">
          <input class="form-check-input" type="checkbox"
                 id="done_{{ log_item.id }}"
                 name="done_{{ log_item.id }}"
                 {% if log_item.is_done %}checked{% endif %}>
          <label class="form-check-label" for="done_{{ log_item.id }}">
            Done
          </label>
        </div>
      </div>
      <div class="card-body">
        <label for="desc_{{ log_item.id }}" class="form-label">Notes / Description</label>
        <textarea id="desc_{{ log_item.id }}"
                  name="desc_{{ log_item.id }}"
                  class="form-control ckeditor"
                  rows="4">{{ log_item.description }}</textarea>
        <div class="mt-2">
          <label for="screenshot_{{ log_item.id }}" class="form-label">Upload Screenshot (optional):</label>
          <input type="file" id="screenshot_{{ log_item.id }}" name="screenshot_{{ log_item.id }}" class="form-control">
        </div>
      </div>
    </div>
    {% endfor %}

    <!-- Action Buttons -->
    <div class="mt-4 d-flex gap-3">
      <button type="button" id="save-button" class="btn btn-primary">Save Changes</button>
      <button type="button" id="complete-button" class="btn btn-success">Complete</button>
      <a href="{% url 'maintenance_dashboard' %}" class="btn btn-secondary">Back</a>
    </div>
  </form>
</div>

<!-- Modal for Confirming Completion -->
<div class="modal fade" id="confirmCompleteModal" tabindex="-1" aria-labelledby="confirmCompleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="complete-form">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmCompleteModalLabel">Confirm Completion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to mark this task as completed?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Yes, Complete</button>
        </div>
      </div>
    </form>
  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function(){
    const saveButton = document.getElementById("save-button");
    const completeButton = document.getElementById("complete-button");
    const claimDetailsForm = document.getElementById("claim-details-form");
    const confirmCompleteModal = new bootstrap.Modal(document.getElementById('confirmCompleteModal'), {});
    const completeForm = document.getElementById("complete-form");

    // Timer functionality
    let startTime = new Date("{{ task.claimed_at|date:'Y-m-d H:i:s' }} UTC");
    let timerInterval = setInterval(function(){
        let now = new Date();
        let elapsed = now - startTime;
        let hours = Math.floor(elapsed / (1000 * 60 * 60));
        let minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
        let seconds = Math.floor((elapsed % (1000 * 60)) / 1000);
        document.getElementById("timer").textContent =
            `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
    }, 1000);

    function pad(num) {
        return num.toString().padStart(2, '0');
    }

    // Autosave functionality
    let autosaveInterval = setInterval(function(){
        saveClaimDetails();
    }, 30000);

    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    function saveClaimDetails(){
        // Aktualisiere alle CKEditor‑Instanzen vor dem Sammeln der FormData:
        for (var instanceName in CKEDITOR.instances) {
            CKEDITOR.instances[instanceName].updateElement();
        }
        const formData = new FormData(claimDetailsForm);
        fetch("{% url 'maintenance_task_edit' task.id %}", {
            method: "POST",
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if(data.success){
                console.log("Autosaved successfully.");
            } else {
                console.error("Autosave failed:", data.error);
            }
        })
        .catch(error => {
            console.error("Error during autosave:", error);
        });
    }

    saveButton.addEventListener("click", function(){
        saveClaimDetails();
        clearInterval(autosaveInterval);
        alert("Changes saved successfully.");
    });

    completeButton.addEventListener("click", function(){
        confirmCompleteModal.show();
    });

    completeForm.addEventListener("submit", function(e){
        e.preventDefault();
        saveClaimDetails();
        fetch("{% url 'maintenance_task_complete' task.id %}", {
            method: "POST",
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if(data.success){
                confirmCompleteModal.hide();
                alert("Task marked as completed.");
                window.location.href = "{% url 'maintenance_dashboard' %}";
            } else {
                alert("Failed to complete the task: " + data.error);
            }
        })
        .catch(error => {
            console.error("Error completing task:", error);
            alert("An error occurred while completing the task.");
        });
    });

    window.addEventListener('beforeunload', function(){
        clearInterval(timerInterval);
        clearInterval(autosaveInterval);
    });
});
</script>
{% endblock %}
