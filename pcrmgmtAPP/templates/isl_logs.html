{% extends 'base.html' %}

{% block title %}ISL Logs{% endblock %}

{% block content %}
<div class="my-4">
    <h1>ISL Logs</h1>
    <div class="d-flex justify-content-between align-items-start mb-3">
        <!-- Search, Items Per Page und Benutzer Dropdown -->
        <form method="GET" id="pagination-form" class="d-flex align-items-center gap-2">
            <!-- Suche -->
            <div>
                <label for="search" class="form-label visually-hidden">Search</label>
                <input type="text" id="search" name="search" value="{{ search_query }}" class="form-control" placeholder="Search by Benutzer, Firma, or Memo">
            </div>

            <!-- Benutzer Dropdown -->
            <div>
                <label for="filter_user" class="form-label visually-hidden">Filter by Benutzer</label>
                <select id="filter_user" name="filter_user" class="form-select" onchange="document.getElementById('pagination-form').submit();">
                    <option value="" {% if not filter_user %}selected{% endif %}>All Users</option>
                    {% for user in unique_users %}
                    <option value="{{ user }}" {% if user == filter_user %}selected{% endif %}>{{ user }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Anzahl der EintrÃ¤ge -->
            <div>
                <label for="per_page" class="form-label visually-hidden">Items per page</label>
                <select id="per_page" name="per_page" class="form-select" onchange="document.getElementById('pagination-form').submit();">
                    <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                    <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                    <option value="75" {% if per_page == 75 %}selected{% endif %}>75</option>
                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                </select>
            </div>
        </form>
    </div>

    <!-- Logs Table -->
    <table class="table table-striped table-hover">
        <thead class="table-primary">
            <tr>
                <th>Indicator</th>
                <th>Actions</th>
                <th>SessionID</th>
                <th>Startzeit</th>
                <th>Dauer</th>
                <th>Benutzer</th>
                <th>NameFirma</th>
                <th>Verrechnet</th>
                <th>Memo</th>
            </tr>
        </thead>
        <tbody id="logs-table-body">
            {% for entry in entries %}
            <tr>
                <td class="clickable-indicator {% if entry.5 %}indicator-cell-verrechnet{% else %}indicator-cell-nicht-verrechnet{% endif %}" data-session-id="{{ entry.0 }}">
                    <span class="{% if entry.5 %}indicator-verrechnet{% else %}indicator-nicht-verrechnet{% endif %}"></span>
                </td>
                <td class="d-flex gap-2">
                    <a href="{% url 'edit_isl_log' log_id=entry.0 %}" class="btn btn-sm btn-primary" title="Edit">
                        <i class="bi bi-pencil-square"></i>
                    </a>
                    <a href="{% url 'delete_isl_log' log_id=entry.0 %}" class="btn btn-sm btn-danger" title="Delete" onclick="return confirm('Are you sure?');">
                        <i class="bi bi-trash"></i>
                    </a>
                    <a href="{% url 'print_isl_log' log_id=entry.0 %}" class="btn btn-sm btn-secondary" title="Print">
                        <i class="bi bi-printer"></i>
                    </a>
                    <a href="{% url 'download_isl_pdf' log_id=entry.0 %}" class="btn btn-sm btn-info" title="Download PDF">
                        <i class="bi bi-file-earmark-pdf"></i>
                    </a>
                </td>
                <td class="no-wrap">{{ entry.0 }}</td>
                <td class="no-wrap">{{ entry.1 }}</td>
                <td class="no-wrap">{{ entry.2 }}</td>
                <td class="no-wrap">{{ entry.3 }}</td>
                <td class="no-wrap">{{ entry.4 }}</td>
                <td>
                    <span
                        class="toggle-verrechnet {% if entry.5 %}text-success{% else %}text-danger{% endif %}"
                        data-session-id="{{ entry.0 }}"
                        style="cursor: pointer;"
                    >
                        {{ entry.5|yesno:"Yes,No" }}
                    </span>
                </td>
                <td class="no-wrap">{{ entry.6 }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9" class="text-center">No logs found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination -->
    <div class="pagination d-flex justify-content-center my-4">
        {% if entries.has_previous %}
        <a href="?page={{ entries.previous_page_number }}&per_page={{ per_page }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&filter_user={{ filter_user }}" class="btn btn-outline-primary me-2">&laquo; Previous</a>
        {% endif %}
        <span class="align-self-center">Page {{ entries.number }} of {{ entries.paginator.num_pages }}</span>
        {% if entries.has_next %}
        <a href="?page={{ entries.next_page_number }}&per_page={{ per_page }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&filter_user={{ filter_user }}" class="btn btn-outline-primary ms-2">Next &raquo;</a>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const indicators = document.querySelectorAll(".clickable-indicator");
        indicators.forEach(indicator => {
            indicator.addEventListener("click", function() {
                const sessionId = this.dataset.sessionId;
                fetch(`/isl-logs/toggle-verrechnet/${sessionId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Content-Type": "application/json"
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const span = this.querySelector("span");
                        span.className = data.new_value ? "indicator-verrechnet" : "indicator-nicht-verrechnet";
                        this.className = data.new_value ? "clickable-indicator indicator-cell-verrechnet" : "clickable-indicator indicator-cell-nicht-verrechnet";
                    } else {
                        console.error(data.error);
                        alert("Failed to toggle Verrechnet status.");
                    }
                })
                .catch(error => {
                    console.error(error);
                    alert("An error occurred while toggling Verrechnet status.");
                });
            });
        });
    });
</script>
{% endblock %}
