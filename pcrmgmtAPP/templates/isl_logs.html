{% extends "base.html" %}
{% load static %}
{% load custom_time %}

{% block title %}ISL Logs{% endblock %}

{% block content %}
<div class="my-4">
    <h1>ISL Logs</h1>

    <!-- Search & Filter Form -->
    <div class="d-flex justify-content-between align-items-start mb-3">
        <form method="GET" id="pagination-form" class="d-flex align-items-center gap-2">
            <input type="text" id="search" name="search" value="{{ search_query }}" class="form-control"
                   placeholder="Search by Benutzer, Firma, or Memo">

            <select id="filter_user" name="filter_user" class="form-select"
                    onchange="document.getElementById('pagination-form').submit();">
                <option value="" {% if not filter_user %}selected{% endif %}>All Users</option>
                {% for user in unique_users %}
                    <option value="{{ user }}" {% if user == filter_user %}selected{% endif %}>{{ user }}</option>
                {% endfor %}
            </select>

            <select id="per_page" name="per_page" class="form-select"
                    onchange="document.getElementById('pagination-form').submit();">
                <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                <option value="75" {% if per_page == 75 %}selected{% endif %}>75</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
            </select>

            <button type="submit" class="btn btn-secondary">Filter</button>
        </form>
    </div>

    <!-- ISL Logs Table -->
    <table class="table table-striped table-hover">
        <thead class="table-primary">
            <tr>
                <!-- Left column with Indicator + Actions, no SessionID displayed -->
                <th style="min-width:200px;">Indicator + Actions</th>
                <th>Startzeit</th>
                <th>Dauer</th>
                <th>Benutzer</th>
                <th>NameFirma</th>
                <th>Verrechnet</th>
                <th>Memo</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in entries %}
            <!-- entry => [SessionID, Startzeit, Dauer, Benutzer, NameFirma, Verrechnet, Memo] -->
            <tr>
                <!-- 1) Indicator + Actions (LEFT side) -->
                <td class="d-flex align-items-center gap-2">
                    <!-- Square indicator (clickable) -->
                    <div class="square-indicator {% if entry.5 %}square-verrechnet{% else %}square-nicht-verrechnet{% endif %}"
                         style="width:24px; height:24px; cursor:pointer;"
                         data-session-id="{{ entry.0 }}">
                    </div>

                    <!-- Edit -->
                    <a href="{% url 'edit_isl_log' entry.0 %}" class="btn btn-sm btn-primary" title="Edit">
                        <i class="bi bi-pencil-square"></i>
                    </a>

                    <!-- Delete -->
                    <form method="POST" action="{% url 'delete_isl_log' entry.0 %}" onsubmit="return confirm('Sure?');" class="d-inline">
                        {% csrf_token %}
                        <button class="btn btn-sm btn-danger" type="submit" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </form>

                    <!-- Print -->
                    <a href="{% url 'print_isl_log' entry.0 %}" class="btn btn-sm btn-secondary" title="Print">
                        <i class="bi bi-printer"></i>
                    </a>

                    <!-- PDF -->
                    <a href="{% url 'download_isl_pdf' entry.0 %}" class="btn btn-sm btn-info" title="Download PDF">
                        <i class="bi bi-file-earmark-pdf"></i>
                    </a>
                </td>

                <!-- 2) Startzeit mit +2 Stunden -->
                <td>{{ entry.1|add_hours:2|date:"Y-m-d H:i" }}</td>

                <!-- 3) Dauer -->
                <td>{{ entry.2 }}</td>

                <!-- 4) Benutzer -->
                <td>{{ entry.3 }}</td>

                <!-- 5) NameFirma -->
                <td>{{ entry.4 }}</td>

                <!-- 6) Verrechnet -->
                <td>
                    <span class="{% if entry.5 %}text-success{% else %}text-danger{% endif %}">
                        {{ entry.5|yesno:"Yes,No" }}
                    </span>
                </td>

                <!-- 7) Memo -->
                <td>{{ entry.6 }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center">No logs found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination -->
    <div class="pagination d-flex justify-content-center my-4">
        {% if entries.has_previous %}
        <a class="btn btn-outline-primary me-2"
           href="?page={{ entries.previous_page_number }}&per_page={{ per_page }}&search={{ search_query }}&filter_user={{ filter_user }}">
           &laquo; Previous
        </a>
        {% endif %}
        <span class="align-self-center mx-2">
            Page {{ entries.number }} of {{ entries.paginator.num_pages }}
        </span>
        {% if entries.has_next %}
        <a class="btn btn-outline-primary ms-2"
           href="?page={{ entries.next_page_number }}&per_page={{ per_page }}&search={{ search_query }}&filter_user={{ filter_user }}">
           Next &raquo;
        </a>
        {% endif %}
    </div>
</div>

<!-- JavaScript for toggling "Verrechnet" via the square -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const csrftoken = "{{ csrf_token }}";
    document.querySelectorAll(".square-indicator").forEach(sq => {
        sq.addEventListener("click", function() {
            const sessionId = this.dataset.sessionId;
            fetch(`/isl-logs/toggle-verrechnet/${sessionId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrftoken
                }
            })
            .then(resp => resp.json())
            .then(data => {
                if (data.success) {
                    // 'Verrechnet' is in the 6th column of the row
                    const row = sq.closest("tr");
                    const verrechnetSpan = row.querySelector("td:nth-child(6) span");
                    if (data.new_value) {
                        // changed from No => Yes
                        sq.classList.remove("square-nicht-verrechnet");
                        sq.classList.add("square-verrechnet");
                        verrechnetSpan.classList.remove("text-danger");
                        verrechnetSpan.classList.add("text-success");
                        verrechnetSpan.textContent = "Yes";
                    } else {
                        // changed from Yes => No
                        sq.classList.remove("square-verrechnet");
                        sq.classList.add("square-nicht-verrechnet");
                        verrechnetSpan.classList.remove("text-success");
                        verrechnetSpan.classList.add("text-danger");
                        verrechnetSpan.textContent = "No";
                    }
                } else {
                    alert("Failed to toggle Verrechnet: " + data.error);
                }
            })
            .catch(err => {
                console.error(err);
                alert("Error toggling Verrechnet.");
            });
        });
    });
});
</script>
{% endblock %}
